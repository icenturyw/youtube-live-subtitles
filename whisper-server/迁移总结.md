# PostgreSQL 数据库迁移总结

## ✅ 已完成的工作

### 1. 代码修改
- ✅ 创建了 `db/postgres_db.py` - PostgreSQL 数据库连接模块
- ✅ 更新了 `server.py` - 集成 PostgreSQL 支持
- ✅ 更新了 `requirements.txt` - 添加 psycopg2-binary 依赖
- ✅ 更新了 `.env` - 添加 PostgreSQL 配置

### 2. 迁移工具
- ✅ 创建了 `migrate_to_postgres.py` - 数据迁移脚本
- ✅ 创建了 `test_postgres_connection.py` - 连接测试脚本

### 3. 数据库配置
```
主机: 83.229.124.177
端口: 5432
数据库: ytb_subtitles
用户名: ytb_subtitles
密码: 3rnmdw4D3EYTkPRZ
```

## ⚠️ 当前状态

**连接测试失败** - 无法连接到 PostgreSQL 服务器

可能原因:
1. 防火墙阻止了端口 5432
2. PostgreSQL 服务器未配置允许远程连接
3. 网络连接问题

## 📋 下一步操作

### 方案 A: 解决连接问题(推荐)

1. **检查服务器端 PostgreSQL 配置**
   
   编辑 `postgresql.conf`:
   ```conf
   listen_addresses = '*'
   port = 5432
   ```
   
   编辑 `pg_hba.conf`:
   ```conf
   host    ytb_subtitles    ytb_subtitles    0.0.0.0/0    md5
   ```
   
   重启 PostgreSQL 服务:
   ```bash
   sudo systemctl restart postgresql
   ```

2. **检查防火墙**
   ```bash
   # 在服务器上开放端口
   sudo ufw allow 5432/tcp
   # 或
   sudo firewall-cmd --permanent --add-port=5432/tcp
   sudo firewall-cmd --reload
   ```

3. **测试连接**
   ```powershell
   python test_postgres_connection.py
   ```

4. **运行迁移**
   ```powershell
   python migrate_to_postgres.py
   ```

### 方案 B: 在服务器端迁移

如果无法从本地连接,可以:

1. 将以下文件上传到服务器:
   - `db/postgres_db.py`
   - `migrate_to_postgres.py`
   - `cache/` 目录(包含所有本地缓存数据)

2. 在服务器上运行:
   ```bash
   pip install psycopg2-binary
   python migrate_to_postgres.py
   ```

### 方案 C: 手动创建表结构

如果只需要创建表结构,可以在 PostgreSQL 中执行:

```sql
-- 连接到数据库
\c ytb_subtitles

-- 创建表
CREATE TABLE IF NOT EXISTS subtitles (
    id SERIAL PRIMARY KEY,
    video_id VARCHAR(255) UNIQUE NOT NULL,
    language VARCHAR(50),
    target_lang VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    subtitles JSONB NOT NULL
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_video_id ON subtitles(video_id);
CREATE INDEX IF NOT EXISTS idx_created_at ON subtitles(created_at);

-- 验证
SELECT COUNT(*) FROM subtitles;
```

## 🚀 启动服务

即使迁移未完成,服务也可以正常运行:

```powershell
cd whisper-server
python server.py
```

服务会:
- 尝试连接 PostgreSQL
- 如果失败,回退到 MongoDB 或本地缓存模式
- 继续正常工作

## 📊 数据策略

当前配置采用**多层缓存策略**:

### 读取顺序
1. 本地缓存文件 (最快)
2. PostgreSQL (如果连接成功)
3. MongoDB (备用)

### 写入策略
- 同时写入所有可用的存储:
  - 本地缓存 (必须)
  - PostgreSQL (如果连接成功)
  - MongoDB (如果连接成功)

这确保了:
- ✅ 即使 PostgreSQL 连接失败,服务仍可正常运行
- ✅ 数据有多重备份
- ✅ 最佳性能(优先使用本地缓存)

## 📝 验证迁移

迁移成功后,可以验证:

```powershell
# 测试连接
python test_postgres_connection.py

# 查看迁移日志
type migration.log

# 启动服务并观察日志
python server.py
```

在 `server.log` 中应该看到:
```
PostgreSQL 连接成功: 83.229.124.177:5432/ytb_subtitles
```

## 🔧 故障排除

### 问题: 连接超时
**解决**: 检查防火墙和 PostgreSQL 配置

### 问题: 认证失败
**解决**: 确认用户名和密码正确

### 问题: 数据库不存在
**解决**: 在 PostgreSQL 中创建数据库:
```sql
CREATE DATABASE ytb_subtitles OWNER ytb_subtitles;
```

---

**准备完成日期**: 2026-01-30
**状态**: 代码已就绪,等待网络连接解决
